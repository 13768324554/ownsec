#!/bin/bash -i


## Metasploit-Framework Setup - XFCE, 16.04

######################## CONFIG_MAIN - START ########################

#1i

GITREPO=https://github.com/rapid7/metasploit-framework
BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RBENVEXECDIR=/opt/ownsec/ITSEC-Install-Scripts-ORIG/3.Exploitation-Tools/metasploit/rbenv-sh
GITCLONEDIR=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7
EXECUTEABLE1=msfconsole.sh 
EXECUTEABLE2=msfd.sh 
EXECUTEABLE3=msfrpc.sh 
EXECUTEABLE4=msfrpcd.sh
EXECUTEABLE5=msfvenom.sh
EXECUTEABLE6=msfbinscan.sh
EXECUTEABLE7=msfelfscan.sh
EXECUTEABLE8=msfmachscan.sh 
EXECUTEABLE9=msfpescan.sh
EXECUTEABLE10=msfupdate.sh
EXECUTEABLE11=msfconsole
EXECUTEABLE12=msfd
EXECUTEABLE13=msfrpc
EXECUTEABLE14=msfrpcd
EXECUTEABLE15=msfvenom
EXECUTEABLE16=msfbinscan
EXECUTEABLE17=msfelfscan
EXECUTEABLE18=msfmachscan
EXECUTEABLE19=msfpescan
EXECUTEABLE20=msfupdate
BINDIR=/usr/local/bin
DSKTPFLS=/opt/ownsec/ITSEC-Install-Scripts-ORIG/3.Exploitation-Tools/metasploit-framework/menu_files
DSKTPFLSDEST=/home/$USER/.local/share/applications/3.Exploitation-Tools/metasploit-framework/menu_files
DSKTPFL1=msfconsole.desktop
DSKTPFL2=msfbinscan.desktop
DSKTPFL3=msfelfscan.desktop
DSKTPFL4=msfmachscan.desktop
DSKTPFL5=msfpescan.desktop
DSKTPFL6=msfrop.desktop
DSKTPFL7=msfvenom.desktop
DSKTPFL8=msfupdate.desktop
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
APTLSTDIR=/opt/ownsec/ITSEC-Install-Scripts-ORIG/3.Exploitation-Tools/metasploit-framework

# psql setup options
POSTGRES_USER="postgres"
MSF_PASS=`cat /dev/urandom |base64 | head -c8`
POSTGRES_PASS=`cat /dev/urandom |base64 | head -c8`
PG_VER=`psql --version | awk '{print $3}' | cut -d. -f1,2`
MSFDBNAME=msf
MSFDBUSRNAME=msf
MSFDBP=msf

######################## CONFIG_MAIN - END ########################
#ph1a

BANNER () {

echo "${bold}
 __  __ _____ _____  _    ____  ____  _     ___ ___ _____ 
|  \/  | ____|_   _|/ \  / ___||  _ \| |   / _ \_ _|_   _|
| |\/| |  _|   | | / _ \ \___ \| |_) | |  | | | | |  | |  
| |  | | |___  | |/ ___ \ ___) |  __/| |__| |_| | |  | |  
|_|  |_|_____| |_/_/   \_\____/|_|   |_____\___/___| |_|  
           
INSTALL
rapid7/metasploit-framework
# installation script by alphaaurigae
${normal}"
}

RBENVINST () {
# check if rbenv is installed, if not install
if [ ! -d /home/$USER/.rbenv ]; then
echo "rbenv not installed, installing!"
cd /opt/ownsec/0.Initial/src/PT2/1.Deps_Install/4.Rbenv
./Rbenv-Ruby_Install_GitHub.sh
source ~/.bashrc
fi
# end rbenv install
}

MSFPSQL () {


sudo ldconfig
sudo updatedb
#sudo xterm 

sudo service postgresql start
sudo service postgresql status

# Setup the DB without userinteraction - unattended so that the main script is not interrupted.
sudo -i -u $POSTGRES_USER << EOF
createuser msf || true
#psql -c "ALTER USER $MSFDBUSRNAME WITH ENCRYPTED PASSWORD 'msf';"
psql -c "ALTER USER $MSFDBUSRNAME WITH PASSWORD '$MSFDBP';"
createdb --owner=$MSFDBUSRNAME $MSFDBNAME || true

#psql -c "ALTER USER $POSTGRES_USER WITH ENCRYPTED PASSWORD '$POSTGRES_PASS';"

#echo "host    all    postgres    127.0.0.1/32    md5" > "/etc/postgresql/$PG_VER/main/pg_hba.conf"
#echo "host    msf    msf    127.0.0.1/32    md5" >> "/etc/postgresql/$PG_VER/main/pg_hba.conf"

#echo "localhost:5432:*:postgres:$POSTGRES_PASS" > ~/.pgpass
#echo "localhost:5432:msf:msf:msf" >> ~/.pgpass
#chmod 0600 ~/.pgpass

echo "listen_addresses = 'localhost'" >> "/etc/postgresql/$PG_VER/main/postgresql.conf"

exit
EOF

# sudo service postgresql restart
# sudo service postgresql start
# sudo service postgresql status
}

INSTDEPS () {

sudo apt-get update
sudo apt-get upgrade
xargs -a <(awk '/^\s*[^#]/' "$APTLSTDIR/deps-metasploit.txt") -r -- sudo apt-get install -y

sudo service postgresql stop
sudo systemctl disable postgresql.service

sudo service apache2 stop
sudo systemctl disable apache2.service

sudo service php7.0-fpm stop
sudo systemctl disable php7.0-fpm.service

sudo updatedb
sudo ldconfig
}

######################## SETUP TOUINES - START ########################
WRTEAPPFLS () {
# sudo bash -c 'for MSF in $(ls msf*); do ln -s $GITREPOROOT/$MSF $BINDIR/$MSF;done'

echo '
#!/bin/bash 

echo "running msfconsole with rbenv"
BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
#rbenv shell 2.4.1 
cd $GITREPOROOT
echo $RUBYVERSION
ruby -v
rbenv sudo ./msfconsole "$@"' > $GITREPOROOT/$EXECUTEABLE1
chmod +x $GITREPOROOT/$EXECUTEABLE1


echo '#!/bin/bash 


BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfd "$@"' > $GITREPOROOT/$EXECUTEABLE2
chmod +x $GITREPOROOT/$EXECUTEABLE2


echo '#!/bin/bash 

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfrpc "$@"' > $EXECUTEABLE3
chmod +x $EXECUTEABLE3


echo '#!/bin/bash 

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfrpcd "$@"' > $GITREPOROOT/$EXECUTEABLE4
chmod +x $GITREPOROOT/$EXECUTEABLE4


echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfvenom "$@"' > $EXECUTEABLE5
chmod +x $EXECUTEABLE5

echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfbinscan "$@"' > $GITREPOROOT/$EXECUTEABLE6
chmod +x $GITREPOROOT/$EXECUTEABLE6

echo '#!/bin/bash 

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfelfscan "$@"' > $EXECUTEABLE7
chmod +x $EXECUTEABLE7

echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfmachscan "$@"' > $GITREPOROOT/$EXECUTEABLE8
chmod +x $GITREPOROOT/$EXECUTEABLE8

echo '#!/bin/bash

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework

echo "running with rbenv"

source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
rbenv shell $RUBYVERSION 
cd $GITREPOROOT
./msfpescan "$@"' > $GITREPOROOT/$EXECUTEABLE9
chmod +x $GITREPOROOT/$EXECUTEABLE9

echo '#!/bin/bash 

. /opt/ownsec/ITSEC-Install-Scripts-ORIG/001.functions/all-scripts.sh

BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )

cd $GITREPOROOT

echo "running with rbenv"
. ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install $RUBYVERSION
rbenv rehash
sudo updatedb
sudo ldconfig
rbenv shell $RUBYVERSION
 
cd $GITREPOROOT
GITSBMDLINIT
git pull
gem install bundler
bundle install
 ' > $GITREPOROOT/$EXECUTEABLE10
chmod +x $GITREPOROOT/$EXECUTEABLE10
}

SMLNK1 () {
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE11
sudo ln -s $GITREPOROOT/$EXECUTEABLE2 $BINDIR/$EXECUTEABLE12
sudo ln -s $GITREPOROOT/$EXECUTEABLE3 $BINDIR/$EXECUTEABLE13
sudo ln -s $GITREPOROOT/$EXECUTEABLE4 $BINDIR/$EXECUTEABLE14
sudo ln -s $GITREPOROOT/$EXECUTEABLE5 $BINDIR/$EXECUTEABLE15
sudo ln -s $GITREPOROOT/$EXECUTEABLE6 $BINDIR/$EXECUTEABLE16
sudo ln -s $GITREPOROOT/$EXECUTEABLE7 $BINDIR/$EXECUTEABLE17
sudo ln -s $GITREPOROOT/$EXECUTEABLE8 $BINDIR/$EXECUTEABLE18
sudo ln -s $GITREPOROOT/$EXECUTEABLE9 $BINDIR/$EXECUTEABLE19
sudo ln -s $GITREPOROOT/$EXECUTEABLE10 $BINDIR/$EXECUTEABLE20
}

MSFCNFL () {
# dont change the config file here, use functions ~ line 50 MSFDBNAME=
cat > $GITREPOROOT/config/database.yml << EOF
production:
    adapter: postgresql
    database: msf
    username: msf
    password: msf
    host: 127.0.0.1
    port: 5432
    pool: 75
    timeout: 5
EOF
sed -i -e 's/'"database: msf"'/'"database: $MSFDBNAME"'/g' $GITREPOROOT/config/database.yml
sed -i -e 's/'"username: msf"'/'"username: $MSFDBUSRNAME"'/g' $GITREPOROOT/config/database.yml
sed -i -e 's/'"password: msf"'/'"password: $MSFDBP"'/g' $GITREPOROOT/config/database.yml
}

MSFPRFL () {
sudo sh -c "echo export MSF_DATABASE_CONFIG=$GITREPOROOT/config/database.yml >> /etc/profile"
source /etc/profile
sudo ldconfig
sudo updatedb
}

MSFDSKTFLS () {
# del old .desktop file dir
rm -rf $DSKTPFLSDEST
mkdir -p $DSKTPFLSDEST
rm -f $DSKTPFLSDEST/$DSKTPFL1 && cp $DSKTPFLS/$DSKTPFL1 $DSKTPFLSDEST/$DSKTPFL1
rm -f $DSKTPFLSDEST/$DSKTPFL2 && cp $DSKTPFLS/$DSKTPFL2 $DSKTPFLSDEST/$DSKTPFL2
rm -f $DSKTPFLSDEST/$DSKTPFL3 && cp $DSKTPFLS/$DSKTPFL3 $DSKTPFLSDEST/$DSKTPFL3
rm -f $DSKTPFLSDEST/$DSKTPFL4 && cp $DSKTPFLS/$DSKTPFL4 $DSKTPFLSDEST/$DSKTPFL4
rm -f $DSKTPFLSDEST/$DSKTPFL5 && cp $DSKTPFLS/$DSKTPFL5 $DSKTPFLSDEST/$DSKTPFL5
rm -f $DSKTPFLSDEST/$DSKTPFL6 && cp $DSKTPFLS/$DSKTPFL6 $DSKTPFLSDEST/$DSKTPFL6
rm -f $DSKTPFLSDEST/$DSKTPFL7 && cp $DSKTPFLS/$DSKTPFL7 $DSKTPFLSDEST/$DSKTPFL7
rm -f $DSKTPFLSDEST/$DSKTPFL8 && cp $DSKTPFLS/$DSKTPFL8 $DSKTPFLSDEST/$DSKTPFL8
}

RBENVSHLL1 () {

echo -e "is ${PURPLE}${bold} ruby $RUBYVERSION installed? If not, install!${normal}"
which ruby > /dev/null 2>&1
if [ "$?" -eq "0" ]; then
case $dxv in 
$RUBYVERSION)
echo "${bold} $RUBYVERSION is installed! Skipping installation!${normal}"
;;
*)
eval "$(rbenv init -)"
rbenv rehash
rbenv shell $RUBYVERSION
;;
esac

else
echo "${bold} $RUBYVERSION is not installed! Installing!${normal}"
source ~/.bashrc
eval "$(rbenv init -)"
yes "Y" | rbenv install $RUBYVERSION
rbenv rehash
rbenv shell $RUBYVERSION
fi
}
######################## INSTALL ROUTINES - END ########################

######################## MISC - START ########################
# color
bold=$(tput bold)
normal=$(tput sgr0)
CYAN='\e[0;36m'
GREEN='\e[0;32m'
WHITE='\e[0;37m'
RED='\e[0;31m'
YELLOW='\e[0;33m'
BLUE='\e[0;34m'
PURPLE='\e[0;35m'
ORANGE='\e[38;5;166m'

# git clone 
GITCLONEFUNC () {
mkdir -p $GITCLONEDIR
cd $GITCLONEDIR
git clone -b $BRANCH $GITREPO
cd $GITREPOROOT
}
# END git clone 

# init submodules
GITSBMDLINIT () {
	git submodule init
	git submodule update --recursive
	sudo updatedb && sudo ldconfig
}
# END init submodules

######################## MISC - END ########################

######################## RUN ALL ########################

BANNER

echo "... ${bold} git clone && submodule init ${normal}"
#plh11
GITCLONEFUNC
GITSBMDLINIT

echo "... ${bold} install apt-get deps from deps.txt ${normal}"
INSTDEPS

echo "... ${bold} rbenv && ruby setup ${normal}"
RBENVINST

echo "... ${bold} config psql ${normal}"
MSFPSQL

echo "... ${bold} RBENV shell ${normal}"
RBENVSHLL1

echo "... ${bold} gem install bundler && bundle install ${normal}"
cd $GITREPOROOT

gem install bundler
bundle install

echo "... ${bold} write the app files ${normal}"
WRTEAPPFLS

echo "... ${bold} rm old symlinks ${normal}"
sudo rm -f $BINDIR/msf*

echo "... ${bold} create new symlinks ${normal}"
SMLNK1

echo "... ${bold} rm old config file ${normal}"
rm -f $GITREPOROOT/config/database.yml

echo "... ${bold} create new config file ${normal}"
MSFCNFL

echo "... ${bold} write config file location to etc profile ${normal}"
MSFPRFL

echo "... ${bold} msfconsole version test ${normal}"
msfconsole --version

echo "... ${bold} copy desktop files ${normal}"
MSFDSKTFLS

echo -e "${bold} ${GREEN} Metasploit-Framework Setup COMPLETE! ${normal}"
echo "${bold} Run msf* from console, its linked with rbenv! ${normal}"
echo -e "${bold} ${GREEN} See console if errors else hf :) ${normal}"
